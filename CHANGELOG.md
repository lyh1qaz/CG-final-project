# 项目改进记录

## 2026-01-03 - 基本体素法线方向与场景导出修复

### 修复内容

#### 1. 基本体素法线方向修复

| 体素类型 | 修复前问题 | 修复方案 | 文件位置 |
|---------|-----------|---------|----------|
| 圆柱 | 顶部和底部面法线向内 | 调整顶部和底部面索引顺序为逆时针，确保法线向外 | src/GeometryUtils.cpp:190-201 |
| 圆锥 | 侧面法线计算错误 | 调整循环条件和顶点顺序，使用正确的叉积计算法线 | src/GeometryUtils.cpp:237-260 |
| 立方体 | 部分面法线方向错误 | 重新调整顶点索引顺序，确保所有面法线向外 | src/GeometryUtils.cpp:60-67 |
| 平面 | 法线方向错误 | 确保法线方向为向上（+Y） | src/GeometryUtils.cpp:274-290 |
| 球体 | 法线方向错误 | 确保法线向量从球心指向外部 | src/GeometryUtils.cpp:105-107 |

#### 2. 场景导出功能修复

| 问题 | 修复方案 | 文件位置 |
|-----|---------|----------|
| 所有对象被导出为一个整体 | 在导出时同时使用"o"（对象）和"g"（组）命令，确保每个对象在OBJ文件中被正确分离 | src/ModelLoader.cpp:208 |

#### 3. 构建错误修复

| 问题 | 修复方案 | 文件位置 |
|-----|---------|----------|
| 代码页936编码问题 | 将测试文件中的中文注释替换为英文注释 | test_export_simple.cpp |
| 测试程序双重释放 | 移除手动删除对象的代码，由SceneContext析构函数自动处理 | test_export_simple.cpp:18-20 |

### 技术细节

#### 法线方向计算原理
- 法线方向由顶点的叉积决定，遵循右手定则
- 顶点顺序（缠绕顺序）决定了法线方向：
  - 逆时针顺序：法线向外
  - 顺时针顺序：法线向内
- 修复时调整了所有面的顶点索引顺序，确保法线向外

#### OBJ文件格式改进
- 添加了`o`（对象）命令，用于在OBJ文件中分离不同对象
- 保留了`g`（组）命令，确保兼容性
- 每个对象使用独立的顶点、法线和纹理坐标索引范围

### 验证结果

- 项目构建成功，无编译错误
- 生成的OBJ文件导入Blender后，所有体素的法线方向正确
- 场景导出时每个对象被正确分离，可在Blender中单独编辑
- 所有基本体素（立方体、球体、圆柱、圆锥、平面）的法线方向均符合预期

### 使用说明

1. 运行程序后，在UI中创建基本体素
2. 点击"Export Scene"按钮导出场景
3. 将生成的OBJ文件导入Blender
4. 在Blender中查看法线方向（使用"Display > Normals"选项）
5. 确认所有体素的法线方向向外

### 文件变更列表

- `src/GeometryUtils.cpp`：修复了所有基本体素的法线方向
- `src/ModelLoader.cpp`：改进了场景导出功能，添加了对象分离
- `test_export_simple.cpp`：修复了编码问题和双重释放问题
- `CHANGELOG.md`：创建了项目改进记录文档
